var App=App||{};App.Tetorimino={},App.service={},App.Config={col:20,row:10,timeInterval:500},function(){"use strict";App.CellModel=Backbone.Model.extend({defaults:{x:0,y:0}})}(),function(){"use strict";var a=["I","J","L","O","S","T","Z"];App.TetoriminoModel=Backbone.Model.extend({fixed:!1,positions:null,centerPosition:null,initialize:function(){this.positions=this.getStartPosition(),this.centerPosition=this.getStartCenterPosition()},_action:function(a){if(this.fixed)return!0;for(var b=this.getPositionList(),c=0,d=b.length;d>c;c++){var e=b[c],f=e.x+a.x,g=e.y+a.y;if(!App.service.tetoriminoManager.canMoveTo(f,g))return!1}for(var c=0,d=b.length;d>c;c++){var e=b[c];e.x+=a.x,e.y+=a.y}return this.centerPosition.x+=a.x,this.centerPosition.y+=a.y,this.trigger("change"),!0},down:function(){return this._action({x:0,y:1})},right:function(){return this._action({x:1,y:0})},left:function(){return this._action({x:-1,y:0})},rotate:function(){for(var a=this.getPositionList(),b=this.centerPosition,c=[],d=0,e=a.length;e>d;d++){var f=a[d],g=f.x-b.x,h=f.y-b.y,i=-h,j=g;if(i+=b.x,j+=b.y,!App.service.tetoriminoManager.canMoveTo(i,j))return!1;c[d]=this.createPosition({x:i,y:j})}return this.positions=c,this.trigger("change"),!0},createPosition:function(a){return{x:a.x,y:a.y,code:this.getCode()}},getCode:function(){throw new Error("Not implements getCode")},getPositionList:function(){return this.positions},getStartPosition:function(){throw new Error("Not implements getStartPosition")},getStartCenterPosition:function(){throw new Error("Not implements getStartCenterPosition")},fix:function(){this.fixed=!0,this.trigger("fix")},isFixed:function(){return this.fixed},placedIn:function(a,b){for(var c=this.getPositionList(),d=0,e=c.length;e>d;d++){var f=c[d];if(f.x===a&&f.y===b)return!0}return!1}},{factory:function(){var b=_.random(0,a.length-1);return new App.Tetorimino[a[b]]}})}(),function(){"use strict";App.Tetorimino.I=App.TetoriminoModel.extend({getCode:function(){return"I"},getStartPosition:function(){return[this.createPosition({x:4,y:0}),this.createPosition({x:4,y:1}),this.createPosition({x:4,y:2}),this.createPosition({x:4,y:3})]},getStartCenterPosition:function(){return{x:4,y:2}}})}(),function(){"use strict";App.Tetorimino.J=App.TetoriminoModel.extend({getCode:function(){return"J"},getStartPosition:function(){return[this.createPosition({x:4,y:0}),this.createPosition({x:4,y:1}),this.createPosition({x:4,y:2}),this.createPosition({x:3,y:2})]},getStartCenterPosition:function(){return{x:4,y:2}}})}(),function(){"use strict";App.Tetorimino.L=App.TetoriminoModel.extend({getCode:function(){return"L"},getStartPosition:function(){return[this.createPosition({x:3,y:0}),this.createPosition({x:3,y:1}),this.createPosition({x:3,y:2}),this.createPosition({x:4,y:2})]},getStartCenterPosition:function(){return{x:3,y:2}}})}(),function(){"use strict";App.Tetorimino.O=App.TetoriminoModel.extend({getCode:function(){return"O"},getStartPosition:function(){return[this.createPosition({x:3,y:0}),this.createPosition({x:3,y:1}),this.createPosition({x:4,y:0}),this.createPosition({x:4,y:1})]},getStartCenterPosition:function(){return{x:4,y:0}},rotate:function(){return!0}})}(),function(){"use strict";App.Tetorimino.S=App.TetoriminoModel.extend({getCode:function(){return"S"},getStartPosition:function(){return[this.createPosition({x:5,y:0}),this.createPosition({x:4,y:0}),this.createPosition({x:4,y:1}),this.createPosition({x:3,y:1})]},getStartCenterPosition:function(){return{x:4,y:1}}})}(),function(){"use strict";App.Tetorimino.T=App.TetoriminoModel.extend({getCode:function(){return"T"},getStartPosition:function(){return[this.createPosition({x:5,y:0}),this.createPosition({x:4,y:0}),this.createPosition({x:4,y:1}),this.createPosition({x:3,y:0})]},getStartCenterPosition:function(){return{x:4,y:0}}})}(),function(){"use strict";App.Tetorimino.Z=App.TetoriminoModel.extend({getCode:function(){return"Z"},getStartPosition:function(){return[this.createPosition({x:3,y:0}),this.createPosition({x:4,y:0}),this.createPosition({x:4,y:1}),this.createPosition({x:5,y:1})]},getStartCenterPosition:function(){return{x:4,y:1}}})}(),function(){"use strict";var a=5;App.TetoriminoCollection=Backbone.Collection.extend({model:App.TetoriminoModel,fixedPositionList:null,initialize:function(){for(var b=[],c=0;a>c;c++)b.push(this.createNewTetorimino());this.add(b,{silent:!0}),this.fixedPositionList=[]},createNewTetorimino:function(){return App.TetoriminoModel.factory()},current:function(){return this.at(0)},dequeue:function(){var a=this.shift();return this.add(this.createNewTetorimino()),this.fix(a),this.trigger("dequeue"),a},fix:function(a){this.addFixedPositions(a),this.trigger("fix",a)},addFixedPositions:function(a){for(var b=a.getPositionList(),c=0,d=b.length;d>c;c++){var e=b[c];this.fixedPositionList.push(e)}},getFixedPositionList:function(){return this.fixedPositionList},destroyLine:function(a){var b=this.getFixedPositionList(),c=_.filter(b,function(b){return b.y!==a});c=_.map(c,function(b){return b.y<a&&b.y++,b}),this.fixedPositionList=c,this.trigger("destroyLine",a)},isFixed:function(a,b){return!!this.getFixedPositionList(a,b)},getFixedPosition:function(a,b){var c=this.getFixedPositionList();return _.find(c,function(c){return c.x===a&&c.y===b})}})}(),function(){"use strict";App.TetoriminoManagerModel=Backbone.Model.extend({col:0,row:0,tetoriminoCollection:null,initialize:function(a){this.col=a.col,this.row=a.row,this.tetoriminoCollection=a.tetoriminoCollection},getTetoriminoCollection:function(){return this.tetoriminoCollection},current:function(){return this.tetoriminoCollection.current()},down:function(){this.current().down()||this.fix()},right:function(){this.current().right()},left:function(){this.current().left()},rotate:function(){this.current().rotate()},fix:function(){this.tetoriminoCollection.dequeue(),this.checkFilledLine()},getFixedPositionList:function(){return this.tetoriminoCollection.getFixedPositionList()},checkFilledLine:function(){for(var a=this.getFixedPositionList(),b=0;b<this.col;b++){var c=_.where(a,{y:b});_.uniq(_.pluck(c,"x")).length===this.row&&this.destroyLine(b)}},destroyLine:function(a){this.tetoriminoCollection.destroyLine(a)},canMoveTo:function(a,b){if(0>a||a>this.row-1)return!1;if(0>b||b>this.col-1)return!1;var c=this.getFixedPositionList();if(!c)return!0;for(var d=0,e=c.length;e>d;d++){var f=c[d];if(a===f.x&&b===f.y)return!1}return!0},isGameOver:function(){var a=this.getFixedPositionList();return!!_.where(a,{y:0}).length}})}(),function(){"use strict";App.CellView=Backbone.View.extend({tagName:"td",fixed:!1,x:0,y:0,code:null,initialize:function(a){this.x=a.x,this.y=a.y,this.tetoriminoCollection=App.service.tetoriminoManager.getTetoriminoCollection(),this.listenTo(App.mediator,"cell:watch",this.watchTetorimino),this.listenTo(this.tetoriminoCollection,"dequeue",this.watchTetorimino),this.listenTo(this.tetoriminoCollection,"fix",this.fix),this.listenTo(this.tetoriminoCollection,"destroyLine",this.refresh)},fix:function(a){this.setTetorimino(a)&&(this.fixed=!0)},setTetorimino:function(a){return this.fixed?!1:a.placedIn(this.x,this.y)?(this.setCode(a.getCode()),!0):(this.clearCode(),!1)},setCode:function(a){return a?(this.code=a,void this.$el.addClass(a)):void 0},clearCode:function(){this.code&&(this.$el.removeClass(),this.code=null)},render:function(){var a=this.tetoriminoCollection.current();return this.setTetorimino(a),this},refresh:function(){this.fixed=!1;var a=this.tetoriminoCollection.getFixedPosition(this.x,this.y);return a?(this.setCode(a.code),void(this.fixed=!0)):void this.clearCode()},watchTetorimino:function(){if(!this.fixed){var a=this.tetoriminoCollection.current();this.listenTo(a,"change",this.render)}}})}(),function(){"use strict";App.UserOperatorView=Backbone.View.extend({pressing:!1,el:document.body,events:{keydown:"keydown",keyup:"keyup"},keydown:function(a){this.pressing=!0;var b=a.keyCode||a.which;37==b?App.service.tetoriminoManager.left():39==b?App.service.tetoriminoManager.right():40==b?App.service.tetoriminoManager.down():32==b&&App.service.tetoriminoManager.rotate()},keyup:function(){this.pressing=!1}})}(),function(){"use strict";App.TimerView=Backbone.View.extend({interval:500,initialize:function(){this.loopAction()},loopAction:function(){setTimeout(_.bind(function(){return App.service.tetoriminoManager.down(),App.service.tetoriminoManager.isGameOver()?void alert("Game over!"):void this.loopAction()},this),this.interval)}})}(),function(){"use strict";App.BoardView=Backbone.View.extend({tagName:"table",col:0,row:0,cellCollection:null,initialize:function(a){this.col=a.col,this.row=a.row},render:function(){for(var a=this.col,b=this.row,c=0;a>c;c++){for(var d=$("<tr/>"),e=[],f=0;b>f;f++){var g=new App.CellView({x:f,y:c});e.push(g.$el)}d.append(e),this.$el.append(d)}return this}})}(),function(){"use strict";App.SubSpaceView=Backbone.View.extend({el:"#subspace"})}(),function(){"use strict";App.WorkSpaceView=Backbone.View.extend({el:"#workspace",board:null,initialize:function(a){this.board=a.board},render:function(){return this.$el.append(this.board.render().$el),this}})}(),function(){"use strict";App.AppView=Backbone.View.extend({workspace:null,subspace:null,initialize:function(a){var b=a.col,c=a.row,d=new App.TetoriminoCollection;App.service.tetoriminoManager=new App.TetoriminoManagerModel({col:b,row:c,tetoriminoCollection:d}),this.workspace=new App.WorkSpaceView({board:new App.BoardView({col:b,row:c})}),this.subspace=new App.SubSpaceView(a.subspace||{})},render:function(){this.workspace.render(),this.subspace.render()},start:function(){App.mediator.trigger("cell:watch");new App.UserOperatorView,new App.TimerView}})}(),function(){"use strict";App.mediator=_.extend({},Backbone.Events);var a=App.Config.col,b=App.Config.row,c=new App.AppView({col:a,row:b});c.render(),$(function(){c.start()})}();